<div id="google-login-container">
    <div id="g_id_onload"
         data-client_id="524833148663-so092vm1d7pvhc7o16md17mktetp9dhm.apps.googleusercontent.com" 
         data-callback="handleCredentialResponse"
         data-auto_prompt="false">
    </div>
    <div class="g_id_signin"
         data-type="standard"
         data-size="large"
         data-theme="outline"
         data-text="sign_in_with"
         data-shape="rectangular"
         data-logo_alignment="left">
    </div>
    <div id="user-info-display" style="margin-top:5px; font-size:14px; font-weight:bold; color:#0d47a1; display:none;"></div>
    <button id="signout-button" style="display:none;">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö Google</button>
    <div id="sync-status">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Google Drive</div>
</div>

// ... (‡πÇ‡∏Ñ‡πâ‡∏î HTML ‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°) ...

<script>
// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ñ‡∏≠‡∏î‡∏£‡∏´‡∏±‡∏™ JWT (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°)
function jwt_decode(token) {
    const base64Url = token.split('.')[1];
    const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
    const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
      return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
    }).join(''));
    return JSON.parse(jsonPayload);
}

document.addEventListener("DOMContentLoaded", function(){
    // ... (‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÅ‡∏•‡∏∞‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏á‡∏ó‡∏µ‡πà‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°) ...
    // ... (‡πÄ‡∏ä‡πà‡∏ô dayNames, monthNamesTH, monthSelect, yearSelect, ‡∏Ø‡∏•‡∏Ø) ...

    let userHolidays=[];
    let otChartInstance = null;
    let driveFileId = null; 
    let accessToken = null; 
    let tokenClient = null; // ‡∏¢‡πâ‡∏≤‡∏¢ tokenClient ‡∏°‡∏≤‡πÄ‡∏õ‡πá‡∏ô Global Variable

    const FILE_NAME = "OT_Tracker_Data.json";
    const MIME_TYPE = 'application/json';
    // üí° Client ID ‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å Google Cloud Console (‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô)
    const GSI_CLIENT_ID = "524833148663-so092vm1d7pvhc7o16md17mktetp9dhm.apps.googleusercontent.com"; 

    const today = new Date();
    const currentYear = today.getFullYear();
    
    // ----------------------------------------------------
    // --- Google Sign-In & Drive API Functions (‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á) ---
    // ----------------------------------------------------

    /**
     * @description Initialize GAPI and prepare tokenClient once DOM is ready
     */
    function initializeGoogleAuth() {
        if (typeof gapi !== 'undefined') {
            gapi.load('client', initClient); 
        } else {
            // ‡∏´‡∏≤‡∏Å GAPI ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÇ‡∏´‡∏•‡∏î (‡∏Ñ‡∏ß‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≤‡∏Å <script> tag ‡πÅ‡∏•‡πâ‡∏ß)
            console.warn("gapi not loaded. Retrying...");
            setTimeout(initializeGoogleAuth, 500); 
        }

        // ‡∏™‡∏£‡πâ‡∏≤‡∏á tokenClient ‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤
        tokenClient = google.accounts.oauth2.initTokenClient({
            client_id: GSI_CLIENT_ID,
            scope: 'https://www.googleapis.com/auth/drive.file openid email profile', 
            callback: handleDriveAuthResponse,
        });
    }
    
    // Call initialization after DOMContentLoaded
    if (typeof google !== 'undefined' && google.accounts) {
        // GSI client is already loaded, proceed with GAPI initialization
        initializeGoogleAuth();
    } else {
        // Fallback: wait for all Google libraries to load (should be handled by async defer)
        window.addEventListener('load', initializeGoogleAuth);
    }
    
    /**
     * @description Handle the response from GSI login (Credential)
     */
    window.handleCredentialResponse = (response) => {
        if (response.credential) {
            const payload = jwt_decode(response.credential);
            document.getElementById('user-info-display').textContent = `‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö: ${payload.name} (${payload.email})`;
            document.getElementById('user-info-display').style.display = 'block';

            document.querySelector('.g_id_signin').style.display = 'none';
            signoutBtn.style.display = 'block';

            // üí° ‡∏£‡πâ‡∏≠‡∏á‡∏Ç‡∏≠ Access Token ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Drive API ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
            if (tokenClient) {
                syncStatus.textContent = "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ç‡∏≠‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå Google Drive...";
                // prompt: 'consent' ‡∏à‡∏∞‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á Pop-up ‡∏Ç‡∏≠‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå Drive
                tokenClient.requestAccessToken({ prompt: 'consent' }); 
            } else {
                syncStatus.textContent = "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î Token Client";
                console.error("Token client not initialized.");
            }
        }
    }

    /**
     * @description Handle the Access Token response from Google OAuth
     */
    function handleDriveAuthResponse(tokenResponse) {
        if (tokenResponse && tokenResponse.access_token) {
            accessToken = tokenResponse.access_token;
            syncStatus.textContent = "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Google Drive...";
            
            if (gapi.client) {
                 gapi.client.setToken({ access_token: accessToken });
                 searchFile();
            } else {
                 // ‡∏ñ‡πâ‡∏≤ GAPI ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏° ‡πÉ‡∏´‡πâ‡πÇ‡∏´‡∏•‡∏î‡∏ã‡πâ‡∏≥
                 gapi.load('client', () => {
                    initClient(true); // isFromToken: true
                 }); 
            }
        } else {
            console.error("Failed to get access token for Drive.");
            syncStatus.textContent = "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Drive";
        }
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô GAPI Client initialization
    function initClient(isFromToken = false) {
        gapi.client.init({}).then(function() {
            if (isFromToken && accessToken) {
                 gapi.client.setToken({ access_token: accessToken });
            }
            // ‡∏ñ‡πâ‡∏≤‡∏°‡∏≤‡∏à‡∏≤‡∏Å Token Response ‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏¥‡πà‡∏° searchFile ‡πÄ‡∏•‡∏¢
            if (accessToken) {
                searchFile();
            }
        }, function(error) {
            console.error('Error initializing GAPI client', error);
            syncStatus.textContent = "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ GAPI";
        });
    }
    
    // ... (‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô searchFile, createFileOnDrive, loadDataFromDrive, saveDataToDrive, syncDataFromCloud ‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°) ...
    // ... (‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Sign Out Handler ‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°) ...

    // ... (‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Local Storage, Table Functions, Chart Functions ‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°) ...
    
    // ... (‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ createTable() ‡πÅ‡∏•‡∏∞ Event Listeners ‡∏´‡∏•‡∏±‡∏Å‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°) ...

    createTable(); 
});
</script>
