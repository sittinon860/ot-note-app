<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>‡πÇ‡∏ô‡πá‡∏ï‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏áOT ‡∏£‡∏≠‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà16-15 (OT Manager)</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script async src="https://www.googletagmanager.com/gtag/js?id=G-B2CJVLLCLN"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-B2CJVLLCLN');
</script>  

<style>
/* -------------------- CSS ‡∏´‡∏•‡∏±‡∏Å -------------------- */
* { box-sizing: border-box; }
body { font-family: Arial,sans-serif; margin:5px; background:linear-gradient(135deg,#f0f4ff,#d9e8ff);}
h2{ text-align:center; color:#0d47a1; text-shadow:1px 1px 2px #aaa; margin-bottom:5px;}
.instructions{ background:#e3f2fd; border-left:4px solid #1976d2; padding:5px 10px; margin-bottom:5px; font-size:12px; line-height:1.4;}
.credit{ text-align:center; font-size:11px; color:#555; margin-bottom:5px;}
.version{ text-align:center; font-size:13px; color:#ff6f00; font-weight:bold; margin-bottom:10px; text-shadow:1px 1px 2px #aaa;}
.controls{ display:flex; flex-wrap:wrap; gap:5px; align-items:center; justify-content:center; margin-bottom:5px;}

/* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏õ‡∏∏‡πà‡∏° */
select,button{ padding:5px 8px; font-size:13px; border-radius:8px; border:1px solid #1976d2; background:linear-gradient(to bottom,#42a5f5,#1e88e5); color:white; cursor:pointer; box-shadow:2px 2px 5px rgba(0,0,0,0.2); transition:transform 0.1s;}
select:hover,button:hover{ transform:translateY(-2px);}

/* ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏£‡∏≤‡∏ü */
#showChartBtn{ background:linear-gradient(to bottom,#ff9800,#f57c00); border:1px solid #e65100; }
#showChartBtn:hover{ transform:translateY(-2px); background:linear-gradient(to bottom,#f57c00,#e65100); }
/* ‡∏õ‡∏∏‡πà‡∏°‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ */
#resetBtn{ background:linear-gradient(to bottom,#f44336,#d32f2f); border:1px solid #c62828; }
#resetBtn:hover{ transform:translateY(-2px); background:linear-gradient(to bottom,#d32f2f,#c62828); }
/* ‡∏õ‡∏∏‡πà‡∏°‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î */
#downloadBtn{ background:linear-gradient(to bottom,#4caf50,#388e3c); border:1px solid #1b5e20; }
#downloadBtn:hover{ transform:translateY(-2px); background:linear-gradient(to bottom,#388e3c,#1b5e20); }
/* ‡∏õ‡∏∏‡πà‡∏°‡∏Ñ‡∏∑‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• */
#uploadBtn{ background:linear-gradient(to bottom,#9c27b0,#7b1fa2); border:1px solid #4a148c; }
#uploadBtn:hover{ transform:translateY(-2px); background:linear-gradient(to bottom,#7b1fa2,#4a148c); }

.checkbox-container{ display:flex; flex-wrap:wrap; justify-content:center; gap:3px; font-size:12px; margin-bottom:5px;}
.summary{ text-align:center; background:linear-gradient(to right,#a8ff78,#78ffd6); padding:5px 10px; border-radius:12px; font-weight:bold; font-size:12px; box-shadow:1px 2px 6px rgba(0,0,0,0.2); margin-bottom:10px;}
table{ width:100%; border-collapse:collapse; background:white; font-size:11px; border-radius:12px; overflow:hidden; box-shadow:0 5px 15px rgba(0,0,0,0.2);}
th,td{ border:1px solid #ddd; padding:3px; text-align:center; vertical-align:middle; transition:all 0.2s;}
th{ background:linear-gradient(to bottom,#1976d2,#42a5f5); color:white; text-shadow:1px 1px 2px #333;}
tr:hover{ background:#e3f2fd; transform:scale(1.02); box-shadow:0 4px 10px rgba(0,0,0,0.2);}
input[type="number"], input[type="text"], select{ width:100%; padding:2px; font-size:11px; border-radius:6px; border:1px solid #1976d2; box-shadow:inset 1px 1px 3px rgba(0,0,0,0.1);}
.holiday-personal{ background:#ffd3d3; border-left:4px solid #ff1744; font-weight:bold;}
.holiday-ot{ background:#fff3b2 !important; border-left:4px solid #ffc400; font-weight:bold;}
@media(max-width:480px){h2{font-size:16px;} .controls{flex-direction:column;align-items:stretch;} select,button{font-size:11px;width:100%;} .checkbox-container{font-size:10px;} .summary{font-size:11px;} th,td{font-size:10px;padding:1px;} input[type="number"],input[type="text"],select{font-size:10px;}}
.td-shift .shift-label{ font-weight:bold; margin-bottom:2px; display:block; color:#0d47a1; text-shadow:1px 1px 1px #aaa; }
.td-shift select{ border-radius:6px; border:1px solid #1976d2; appearance:none; -webkit-appearance:none; -moz-appearance:none;
background:white url('data:image/svg+xml;utf8,<svg fill="gray" height="12" viewBox="0 0 24 24" width="12" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/></svg>') no-repeat right 5px center; background-size:12px 12px;}

/* Modal */
.modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); }
.modal-content { background-color: #fefefe; margin: 5% auto; padding: 20px; border-radius: 12px; width: 90%; max-width: 800px; box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2), 0 6px 20px 0 rgba(0,0,0,0.19); animation-name: animatetop; animation-duration: 0.4s }
@keyframes animatetop { from {top: -300px; opacity: 0} to {top: 0; opacity: 1} }
.close-btn { color: #aaa; float: right; font-size: 28px; font-weight: bold;}
.close-btn:hover, .close-btn:focus { color: #000; text-decoration: none; cursor: pointer; }
.chart-container { position: relative; height: 400px; width: 100%; }
.chart-controls { text-align: center; margin-bottom: 10px; font-size: 14px; font-weight: bold; }
</style>
</head>
<body>

<h2>‡πÇ‡∏ô‡πá‡∏ï‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏áOT ‡∏£‡∏≠‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà16-15</h2>

<div class="credit">‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡πÄ‡∏ß‡πá‡∏ö‡∏ô‡∏µ‡πâ‡πÇ‡∏î‡∏¢: ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏ô‡∏ô</div>
<div class="version">‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡πà‡∏ô 3.1 (‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•)</div>

<div class="instructions">
<b>‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô:</b><br>
1. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£<br>
2. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏∞ (N1, D1, HD1, HN1)<br>
3. ‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á OT (1‚Äì3 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á ‡∏ß‡∏±‡∏ô‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤ ‡∏à‡∏∞‡∏Ç‡∏∂‡πâ‡∏ô‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ **"‡∏ï‡∏±‡∏î‡∏Å‡∏•‡∏±‡∏ö"**)<br>
4. ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì OT1 / OT1.5 / OT3 ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥<br>
5. ‡∏Å‡∏î **"‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ"** ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏£‡∏≠‡∏ö‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å<br>
6. üóÉÔ∏è ‡πÉ‡∏ä‡πâ **"‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•" / "‡∏Ñ‡∏∑‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"** ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ OT ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å‡∏´‡∏≤‡∏Å‡∏Ñ‡∏∏‡∏ì‡∏•‡πâ‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå)
</div>

<div class="controls">
‡πÄ‡∏î‡∏∑‡∏≠‡∏ô: <select id="month"></select>
‡∏õ‡∏µ: <select id="year"></select>
<button id="resetBtn">‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</button>
<button id="showChartBtn">‡∏™‡∏£‡∏∏‡∏õ OT ‡∏£‡∏≤‡∏¢‡∏õ‡∏µ</button>
<button id="downloadBtn">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
<button id="uploadBtn">‡∏Ñ‡∏∑‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
<input type="file" id="fileInput" accept=".json" style="display:none;">
</div>

<div class="checkbox-container">
‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß:
<label><input type="checkbox" value="1"> ‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå</label>
<label><input type="checkbox" value="2"> ‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£</label>
<label><input type="checkbox" value="3"> ‡∏û‡∏∏‡∏ò</label>
<label><input type="checkbox" value="4"> ‡∏û‡∏§‡∏´‡∏±‡∏™</label>
<label><input type="checkbox" value="5"> ‡∏®‡∏∏‡∏Å‡∏£‡πå</label>
<label><input type="checkbox" value="6"> ‡πÄ‡∏™‡∏≤‡∏£‡πå</label>
<label><input type="checkbox" value="0"> ‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå</label>
</div>

<div class="summary" id="summary">‡∏£‡∏ß‡∏° OT1:0 | OT1.5:0 | OT3:0</div>

<table id="otTable">
<thead>
<tr>
<th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th>‡∏ß‡∏±‡∏ô</th><th>‡∏Å‡∏∞</th><th>‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á OT</th>
<th>OT1</th><th>OT1.5</th><th>OT3</th>
<th>‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‚Äì‡∏≠‡∏≠‡∏Å</th><th>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
</tr>
</thead>
<tbody></tbody>
</table>

<div id="chartModal" class="modal">
  <div class="modal-content">
    <span class="close-btn">&times;</span>
    <h3 style="text-align:center; color:#0d47a1;">‡∏™‡∏£‡∏∏‡∏õ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á OT ‡∏£‡∏≤‡∏¢‡∏õ‡∏µ</h3>
    <div class="chart-controls">
        ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏µ: <select id="yearChartSelect"></select>
    </div>
    <div class="chart-container">
        <canvas id="otChart"></canvas>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function(){
    const dayNames=["‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå","‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå","‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£","‡∏û‡∏∏‡∏ò","‡∏û‡∏§‡∏´‡∏±‡∏™","‡∏®‡∏∏‡∏Å‡∏£‡πå","‡πÄ‡∏™‡∏≤‡∏£‡πå"];
    const monthNamesTH = ["‡∏°.‡∏Ñ.", "‡∏Å.‡∏û.", "‡∏°‡∏µ.‡∏Ñ.", "‡πÄ‡∏°.‡∏¢.", "‡∏û.‡∏Ñ.", "‡∏°‡∏¥.‡∏¢.", "‡∏Å.‡∏Ñ.", "‡∏™.‡∏Ñ.", "‡∏Å.‡∏¢.", "‡∏ï.‡∏Ñ.", "‡∏û.‡∏¢.", "‡∏ò.‡∏Ñ."];
    const monthSelect=document.getElementById("month");
    const yearSelect=document.getElementById("year");
    const yearChartSelect=document.getElementById("yearChartSelect");
    const tbody=document.getElementById("otTable").querySelector("tbody");
    const summary=document.getElementById("summary");
    const checkboxes=document.querySelectorAll(".checkbox-container input[type=checkbox]");
    const modal = document.getElementById("chartModal");
    const btn = document.getElementById("showChartBtn");
    const span = document.getElementsByClassName("close-btn")[0];
    let userHolidays=[];
    let otChartInstance = null;

    // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Backup/Restore) ---
    const downloadBtn = document.getElementById("downloadBtn");
    const uploadBtn = document.getElementById("uploadBtn");
    const fileInput = document.getElementById("fileInput");

    const today = new Date();
    const currentYear = today.getFullYear();

    // ‡πÇ‡∏´‡∏•‡∏î Dropdown ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏õ‡∏µ
    for(let m=0;m<12;m++){
        const opt=document.createElement("option"); opt.value=m;
        opt.text=new Date(2025,m).toLocaleString("th-TH",{month:"long"});
        monthSelect.appendChild(opt);
    }
    for(let y=currentYear-2;y<=currentYear+2;y++){
        const opt=document.createElement("option"); opt.value=y; opt.text=y; yearSelect.appendChild(opt);
        const optChart=document.createElement("option"); optChart.value=y; optChart.text=y; yearChartSelect.appendChild(optChart);
    }

    // ‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏õ‡∏µ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å localStorage
    const savedMonth=localStorage.getItem("lastSelectedMonth");
    const savedYear=localStorage.getItem("lastSelectedYear");
    monthSelect.value=savedMonth!==null?savedMonth:today.getMonth();
    yearSelect.value=savedYear!==null?savedYear:currentYear;
    yearChartSelect.value = currentYear;

    // ----------------------------------------------------
    function getKeyData(year, month){ 
        if(typeof year === 'undefined') year = yearSelect.value;
        if(typeof month === 'undefined') month = monthSelect.value;
        return `otData_${year}-${parseInt(month)+1}`;
    }
    function getKeyHoliday(){return `holidays_${yearSelect.value}-${parseInt(monthSelect.value)+1}`;}

    // ----------------------------------------------------
    function loadHolidays(){
        const saved = JSON.parse(localStorage.getItem(getKeyHoliday()) || "[]");
        userHolidays = saved.map(d => parseInt(d));
        checkboxes.forEach(cb => cb.checked = userHolidays.includes(parseInt(cb.value)));
    }

    checkboxes.forEach(cb => cb.addEventListener("change", () => {
        userHolidays = Array.from(checkboxes).filter(c=>c.checked).map(cb=>parseInt(cb.value));
        localStorage.setItem(getKeyHoliday(), JSON.stringify(userHolidays));
        createTable();
    }));

    document.getElementById("resetBtn").addEventListener("click", () => {
        if(confirm("‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• OT ‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏ö‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")){
            localStorage.removeItem(getKeyData()); 
            localStorage.removeItem(getKeyHoliday());
            createTable();
        }
    });

    // ----------------------------------------------------
    // 1. ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Backup)
    downloadBtn.addEventListener("click", () => {
        const allData = {};
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            // ‡πÄ‡∏Å‡πá‡∏ö‡∏ó‡∏∏‡∏Å key ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• OT ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤
            if (key.startsWith("otData_") || key.startsWith("holidays_") || key.startsWith("lastSelected")) {
                try {
                    // ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô JSON ‡∏Å‡πà‡∏≠‡∏ô ‡∏´‡∏≤‡∏Å‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß‡πÉ‡∏´‡πâ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏õ‡πá‡∏ô string
                    allData[key] = JSON.parse(localStorage.getItem(key));
                } catch (e) {
                    allData[key] = localStorage.getItem(key);
                }
            }
        }
        if (Object.keys(allData).length === 0) {
            alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• OT ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î");
            return;
        }

        const dataStr = JSON.stringify(allData, null, 2);
        const blob = new Blob([dataStr], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `OT_Backup_${currentYear}-${today.getMonth() + 1}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        alert("‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• OT ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß (‡πÑ‡∏ü‡∏•‡πå‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î/‡πÅ‡∏≠‡∏û‡πÑ‡∏ü‡∏•‡πå)");
    });

    // 2. ‡∏Ñ‡∏∑‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Restore)
    uploadBtn.addEventListener("click", () => {
        // ‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå
        fileInput.click();
    });

    fileInput.addEventListener("change", (event) => {
        const file = event.target.files[0];
        if (!file) return;

        if (!file.name.endsWith(".json")) {
            alert("‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• .json ‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏ß‡πâ");
            return;
        }

        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const importedData = JSON.parse(e.target.result);
                if (typeof importedData !== 'object' || importedData === null) {
                    throw new Error("‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
                }

                if (!confirm("‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• OT ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡∏ö‡∏î‡πâ‡∏ß‡∏¢‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î ‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) {
                    return;
                }

                let importedCount = 0;
                // ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤‡∏Å‡πà‡∏≠‡∏ô (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• OT ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤)
                const keysToRemove = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key.startsWith("otData_") || key.startsWith("holidays_") || key.startsWith("lastSelected")) {
                        keysToRemove.push(key);
                    }
                }
                keysToRemove.forEach(key => localStorage.removeItem(key));
                
                // ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà
                for (const key in importedData) {
                    const valueToStore = (typeof importedData[key] === 'object' && importedData[key] !== null) 
                                         ? JSON.stringify(importedData[key]) 
                                         : importedData[key];
                    localStorage.setItem(key, valueToStore);
                    importedCount++;
                }
                alert(`‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${importedCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏π‡∏Å‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡πÅ‡∏•‡πâ‡∏ß`);
                createTable(); // ‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà
                fileInput.value = ''; // ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô file input
            } catch (error) {
                alert(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ${error.message}. ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÑ‡∏ü‡∏•‡πå JSON ‡∏ß‡πà‡∏≤‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á`);
                fileInput.value = '';
            }
        };
        reader.readAsText(file);
    });

    // ----------------------------------------------------
    function createTable(){
        tbody.innerHTML="";
        loadHolidays();
        const currentMonth = parseInt(monthSelect.value);
        const currentYear = parseInt(yearSelect.value);
        localStorage.setItem("lastSelectedMonth",currentMonth);
        localStorage.setItem("lastSelectedYear",currentYear);

        let startDate = new Date(currentYear, currentMonth, 16);
        let endMonth = currentMonth + 1; 
        let endYear = currentYear;
        if (endMonth > 11){ endMonth = 0; endYear += 1; }
        let endDate = new Date(endYear, endMonth, 15);

        const savedData = JSON.parse(localStorage.getItem(getKeyData()) || "[]"); 
        let current = new Date(startDate);

        while(current <= endDate){
            const tr = document.createElement("tr");
            const day = current.getDay();
            const thYear = current.getFullYear()+543;
            const formattedDate = `${current.getDate().toString().padStart(2,'0')}/${(current.getMonth()+1).toString().padStart(2,'0')}/${thYear}`;

            const tdDate = document.createElement("td"); tdDate.textContent = formattedDate; tr.appendChild(tdDate);
            const tdDay = document.createElement("td"); tdDay.textContent = dayNames[day]; tr.appendChild(tdDay);
            const tdShift = document.createElement("td"); tdShift.classList.add("td-shift");
            const shiftLabel = document.createElement("div"); shiftLabel.classList.add("shift-label"); tdShift.appendChild(shiftLabel);
            const selectShift = document.createElement("select");
            ["","N1","D1","HD1","HN1"].forEach(v=>{ const opt=document.createElement("option"); opt.value=v; opt.text=v; selectShift.appendChild(opt); });
            tdShift.appendChild(selectShift); tr.appendChild(tdShift);
            const tdHours = document.createElement("td");
            const inputHours = document.createElement("input"); inputHours.type="number"; inputHours.min=0; inputHours.max=12; inputHours.step=0.5; inputHours.style.display="none";
            tdHours.appendChild(inputHours); tr.appendChild(tdHours);
            const tdOT1=document.createElement("td"), tdOT15=document.createElement("td"), tdOT3=document.createElement("td"); tr.appendChild(tdOT1); tr.appendChild(tdOT15); tr.appendChild(tdOT3);
            const tdTime=document.createElement("td"); tr.appendChild(tdTime);
            const tdNote=document.createElement("td"); const inputNote=document.createElement("input"); inputNote.type="text"; tdNote.appendChild(inputNote); tr.appendChild(tdNote);

            if(userHolidays.includes(day)) tr.classList.add("holiday-personal");

            tbody.appendChild(tr);

            const idx = savedData.findIndex(d => d.date === formattedDate);
            if(idx >= 0){
                const d = savedData[idx];
                selectShift.value = d.shift; shiftLabel.textContent = d.shift;
                if(d.shift) inputHours.style.display = "inline-block";
                inputHours.value = d.hours;
                tdOT1.textContent = d.ot1 || ""; tdOT15.textContent = d.ot15 || ""; tdOT3.textContent = d.ot3 || "";
                tdTime.textContent = d.time || ""; inputNote.value = d.note || "";
                if(d.shift=="HD1"||d.shift=="HN1"){ tr.classList.remove("holiday-personal"); tr.classList.add("holiday-ot"); }
            }

            selectShift.addEventListener("change", ()=>{
                shiftLabel.textContent = selectShift.value;
                if(selectShift.value){ inputHours.style.display="inline-block"; } else { inputHours.style.display="none"; inputHours.value=""; }
                if(selectShift.value=="HD1"||selectShift.value=="HN1"){ tr.classList.remove("holiday-personal"); tr.classList.add("holiday-ot"); inputNote.value="OT ‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î"; }
                else if(userHolidays.includes(day)){ tr.classList.add("holiday-personal"); tr.classList.remove("holiday-ot"); inputNote.value=""; }
                else { tr.classList.remove("holiday-personal","holiday-ot"); inputNote.value=""; }
                updateRow(tr, selectShift, inputHours, current);
            });

            inputHours.addEventListener("input", ()=>{ updateRow(tr, selectShift, inputHours, current); });

            current.setDate(current.getDate()+1);
        }
        updateSummary();
    }

    function updateRow(tr, selectShift, inputHours, current){
        const tds = tr.querySelectorAll("td");
        const shift = selectShift.value;
        const hours = parseFloat(inputHours.value || 0);
        const tdOT1 = tds[4], tdOT15 = tds[5], tdOT3 = tds[6], tdTime = tds[7], tdNote = tds[8].querySelector("input");
        let ot1=0, ot15=0, ot3=0, startTime="";
        tdOT1.textContent = ""; tdOT15.textContent = ""; tdOT3.textContent = ""; tdTime.textContent = "";

        if(hours>0){
            if(shift=="N1"||shift=="D1"){ ot15 = hours; startTime = (shift=="N1")?"03:45":"15:45"; if(hours>0 && hours<=3){ tdNote.value="‡∏ï‡∏±‡∏î‡∏Å‡∏•‡∏±‡∏ö"; } }
            else if(shift=="HD1"||shift=="HN1"){ startTime=(shift=="HD1")?"07:45":"19:45"; if(hours<=8){ ot1=hours; } else { ot1=8; ot3=hours-8; } tdNote.value="OT ‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î"; }
            if(startTime){ tdTime.textContent=`${startTime} ‚Äì ${addHours(startTime,hours)}`; }
        }

        tdOT1.textContent = ot1?ot1.toFixed(2):"";
        tdOT15.textContent = ot15?ot15.toFixed(2):"";
        tdOT3.textContent = ot3?ot3.toFixed(2):"";

        saveData(); updateSummary();
    }

    function addHours(start,h){ 
        let [hh,mm] = start.split(":").map(Number); 
        let totalMinutes = (hh*60) + mm + Math.round(h*60); 
        let newH = Math.floor(totalMinutes/60)%24;
        let newM = totalMinutes%60;
        return `${newH.toString().padStart(2,'0')}:${newM.toString().padStart(2,'0')}`; 
    }

    function updateSummary(){
        let ot1=0, ot15=0, ot3=0;
        tbody.querySelectorAll("tr").forEach(tr=>{ ot1+=parseFloat(tr.cells[4].textContent||0); ot15+=parseFloat(tr.cells[5].textContent||0); ot3+=parseFloat(tr.cells[6].textContent||0); });
        summary.textContent=`‡∏£‡∏ß‡∏° OT1:${ot1.toFixed(2)} | OT1.5:${ot15.toFixed(2)} | OT3:${ot3.toFixed(2)}`;
    }

    function saveData(){
        const data=[];
        tbody.querySelectorAll("tr").forEach(tr=>{
            const date=tr.cells[0].textContent;
            const shift=tr.cells[2].querySelector("select").value;
            const inputHoursElement=tr.cells[3].querySelector("input");
            const hours=parseFloat(inputHoursElement.value||0);
            const ot1=tr.cells[4].textContent;
            const ot15=tr.cells[5].textContent;
            const ot3=tr.cells[6].textContent;
            const time=tr.cells[7].textContent;
            const note=tr.cells[8].querySelector("input").value;
            data.push({date,shift,hours,ot1,ot15,ot3,time,note});
        });
        localStorage.setItem(getKeyData(),JSON.stringify(data));
    }

    // ----------------------------------------------------
    // ‡∏Å‡∏£‡∏≤‡∏ü OT ‡∏£‡∏≤‡∏¢‡∏õ‡∏µ
    function getMonthlySummaryData(selectedYear){
        const data=[]; const labels=[];
        for(let month=0; month<12; month++){
            const key=getKeyData(selectedYear,month);
            const savedData=JSON.parse(localStorage.getItem(key)||'[]');
            let ot1=0,ot15=0,ot3=0;
            savedData.forEach(d=>{ ot1+=parseFloat(d.ot1||0); ot15+=parseFloat(d.ot15||0); ot3+=parseFloat(d.ot3||0); });
            labels.push(`${monthNamesTH[month]}/${selectedYear%100}`);
            data.push({ monthYear:`${monthNamesTH[month]} ${selectedYear}`, ot1:parseFloat(ot1.toFixed(2)), ot15:parseFloat(ot15.toFixed(2)), ot3:parseFloat(ot3.toFixed(2)), total:parseFloat((ot1+ot15+ot3).toFixed(2)) });
        }
        return { labels, data };
    }

    function renderChart(summaryData){
        const ctx=document.getElementById('otChart').getContext('2d');
        if(otChartInstance){ otChartInstance.destroy(); }
        otChartInstance=new Chart(ctx,{
            type:'bar',
            data:{
                labels:summaryData.labels,
                datasets:[
                    { label:'‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á OT1', data:summaryData.data.map(d=>d.ot1), backgroundColor:'rgba(255, 99, 132, 0.8)', borderColor:'rgba(255, 99, 132, 1)', borderWidth:1 },
                    { label:'‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á OT1.5', data:summaryData.data.map(d=>d.ot15), backgroundColor:'rgba(54, 162, 235, 0.8)', borderColor:'rgba(54, 162, 235, 1)', borderWidth:1 },
                    { label:'‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á OT3', data:summaryData.data.map(d=>d.ot3), backgroundColor:'rgba(75, 192, 192, 0.8)', borderColor:'rgba(75, 192, 192, 1)', borderWidth:1 }
                ]
            },
            options:{
                responsive:true,
                maintainAspectRatio:false,
                plugins:{
                    title:{ display:true, text:`‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á OT ‡∏£‡∏ß‡∏°‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó (12 ‡∏£‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏õ‡∏µ ${yearChartSelect.value})` },
                    tooltip:{
                        callbacks:{
                            label:(tooltipItem)=>{ const label=tooltipItem.dataset.label||''; const value=tooltipItem.parsed.y; return `${label}: ${value.toFixed(2)} ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á`; },
                            footer:(tooltipItems)=>{ const currentMonthData=summaryData.data[tooltipItems[0].dataIndex]; return [`------------------------`,`OT1: ${currentMonthData.ot1.toFixed(2)} ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á`,`OT1.5: ${currentMonthData.ot15.toFixed(2)} ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á`,`OT3: ${currentMonthData.ot3.toFixed(2)} ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á`,`‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${currentMonthData.total.toFixed(2)} ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á`]; }
                        }
                    }
                },
                scales:{ x:{ stacked:true, title:{ display:true, text:'‡∏£‡∏≠‡∏ö‡πÄ‡∏î‡∏∑‡∏≠‡∏ô' } }, y:{ stacked:true, beginAtZero:true, title:{ display:true, text:'‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á OT' } } }
            }
        });
    }

    // ----------------------------------------------------
    // Event Listeners ‡∏´‡∏•‡∏±‡∏Å
    monthSelect.addEventListener("change", createTable);
    yearSelect.addEventListener("change", createTable);

    yearChartSelect.addEventListener("change", ()=>{
        const selectedYear=parseInt(yearChartSelect.value);
        const { labels, data: monthlyData } = getMonthlySummaryData(selectedYear);
        const chartData = { labels: labels, data: monthlyData };
        renderChart(chartData);
    });

    btn.onclick=function(){
        const selectedYear=parseInt(yearChartSelect.value);
        const { labels, data: monthlyData } = getMonthlySummaryData(selectedYear);
        const chartData={ labels: labels, data: monthlyData };
        renderChart(chartData);
        modal.style.display="block";
    }

    span.onclick=function(){ modal.style.display="none"; }
    window.onclick=function(event){ if(event.target==modal){ modal.style.display="none"; } }

    createTable(); // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
});
</script>

</body>
</html>
